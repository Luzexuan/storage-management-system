# 用户注册逻辑说明

## 概述

本文档说明了用户注册和重新申请的逻辑，特别是针对被拒绝用户重新提交申请的情况。

## 用户状态说明

系统中用户有三种状态：

1. **pending** - 待审核：新注册用户的初始状态，等待管理员审核
2. **active** - 激活：管理员批准后的状态，可以正常登录使用系统
3. **inactive** - 未激活/已拒绝：管理员拒绝注册申请后的状态，无法登录

## 注册逻辑

### 场景1：全新注册

当用户使用全新的用户名、邮箱和手机号注册时：

- 系统创建新用户记录，状态为 `pending`
- 返回消息："注册成功，请等待管理员审核"
- HTTP状态码：201

### 场景2：被拒绝用户重新申请（相同信息）

当被拒绝的用户（status = 'inactive'）使用**完全相同**的用户名、邮箱和手机号重新注册时：

- 系统识别为同一用户重新申请
- 更新密码（用户可能修改了密码）
- 将状态从 `inactive` 重置为 `pending`
- 记录操作日志（operation_type: 'user_reapply'）
- 返回消息："申请已重新提交，请等待管理员审核"
- HTTP状态码：200

**示例：**
```
第一次注册：
- 用户名：zhangsan
- 邮箱：zhangsan@example.com
- 手机：13800138000
- 密码：password123
→ 状态：pending → 管理员拒绝 → 状态：inactive

重新申请（相同信息）：
- 用户名：zhangsan
- 邮箱：zhangsan@example.com
- 手机：13800138000
- 密码：newpassword456
→ 系统更新密码，状态从 inactive 改为 pending
```

### 场景3：不同用户使用被拒绝账户的信息

当新用户尝试使用被拒绝账户的用户名、邮箱或手机号时：

- 系统检测到信息冲突
- 明确指出哪些字段冲突（用户名、邮箱、手机号）
- 提示该账户已被拒绝
- 返回错误："[字段]已被其他账户使用（该账户申请已被拒绝），请使用不同的信息注册"
- HTTP状态码：400

**示例：**
```
被拒绝的账户：
- 用户名：zhangsan
- 邮箱：zhangsan@example.com
- 手机：13800138000

新用户尝试注册：
- 用户名：lisi
- 邮箱：zhangsan@example.com  ← 冲突
- 手机：13900139000
→ 错误："邮箱已被其他账户使用（该账户申请已被拒绝），请使用不同的信息注册"
```

### 场景4：与活跃/待审核用户冲突

当用户尝试使用已存在的活跃（active）或待审核（pending）用户的信息时：

- 系统拒绝注册
- 明确指出哪些字段冲突
- 返回错误："[字段]已被使用"
- HTTP状态码：400

## 冲突检测逻辑

系统检查以下字段的唯一性：

1. **用户名** - 必须唯一
2. **邮箱** - 必须唯一
3. **手机号** - 如果提供，必须唯一

检查范围包括所有状态的用户（pending, active, inactive）。

## 操作日志

系统记录两种注册相关的操作：

1. **user_register** - 全新用户注册
2. **user_reapply** - 被拒绝用户重新申请

日志包含的信息：
- operation_type: 操作类型
- operator_id: 用户ID
- target_type: 'user'
- target_id: 用户ID
- operation_detail: { username, email, action }
- ip_address: 请求IP

## API接口

### POST /auth/register

**请求体：**
```json
{
  "username": "zhangsan",
  "password": "password123",
  "email": "zhangsan@example.com",
  "phone": "13800138000"  // 可选
}
```

**成功响应（新用户）：**
```json
{
  "message": "注册成功，请等待管理员审核",
  "userId": 123
}
```
HTTP状态码：201

**成功响应（重新申请）：**
```json
{
  "message": "申请已重新提交，请等待管理员审核",
  "userId": 123
}
```
HTTP状态码：200

**错误响应（信息冲突）：**
```json
{
  "error": "用户名、邮箱已被使用"
}
```
HTTP状态码：400

## 管理员操作

管理员可以通过以下接口审核用户：

### PUT /users/:userId/approve

**请求体：**
```json
{
  "approve": true   // true: 通过, false: 拒绝
}
```

- 批准：状态改为 `active`
- 拒绝：状态改为 `inactive`

## 测试流程

### 测试被拒绝用户重新申请

1. 注册新用户
   ```bash
   POST /auth/register
   {
     "username": "testuser",
     "password": "test123",
     "email": "test@example.com",
     "phone": "13800138000"
   }
   ```

2. 管理员拒绝申请
   ```bash
   PUT /users/{userId}/approve
   {
     "approve": false
   }
   ```

3. 用户重新申请（相同信息）
   ```bash
   POST /auth/register
   {
     "username": "testuser",
     "password": "newpass456",
     "email": "test@example.com",
     "phone": "13800138000"
   }
   ```
   预期结果：成功，状态重置为 pending，密码已更新

4. 其他用户尝试使用相同邮箱
   ```bash
   POST /auth/register
   {
     "username": "anotheruser",
     "password": "pass123",
     "email": "test@example.com",
     "phone": "13900139000"
   }
   ```
   预期结果：失败，提示"邮箱已被其他账户使用（该账户申请已被拒绝）"

## 设计考虑

### 为什么允许被拒绝用户重新申请？

1. **用户体验**：用户可能因为某些原因被拒绝（如信息不完整），修正后应该允许重新申请
2. **灵活性**：给予用户第二次机会，而不是永久封禁某个邮箱
3. **保留历史**：保留原有用户记录，可以追踪审核历史

### 为什么不允许其他人使用被拒绝账户的信息？

1. **防止滥用**：避免恶意用户通过更换用户名来绕过拒绝
2. **数据一致性**：确保同一个邮箱/手机号只属于同一个用户
3. **审核效率**：管理员可以查看该邮箱的历史申请记录

### 为什么更新密码？

被拒绝的用户重新申请时可能想要更改密码，因此系统允许更新密码。即使用户使用相同的密码，重新加密也不会造成问题。

## 未来改进方向

1. 添加申请次数限制，防止频繁重复申请
2. 记录每次申请的详细信息，供管理员参考
3. 添加申请间隔时间限制（如24小时内不能重复申请）
4. 允许管理员永久禁用某些邮箱或用户名
