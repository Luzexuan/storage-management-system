# 用户注册与审核逻辑说明

## 概述

本文档说明了用户注册和审核的逻辑，特别是被拒绝用户如何重新申请的机制。

## 用户状态说明

系统中用户有两种主要状态：

1. **pending** - 待审核：新注册用户的初始状态，等待管理员审核
2. **active** - 激活：管理员批准后的状态，可以正常登录使用系统

注意：系统不再使用 **inactive** 状态。当管理员拒绝注册申请时，用户记录会被直接删除。

## 注册逻辑

### 场景1：全新注册

当用户使用全新的用户名、邮箱和手机号注册时：

- 系统检查用户名、邮箱、手机号是否已存在
- 如果不存在冲突，创建新用户记录，状态为 `pending`
- 返回消息："注册成功，请等待管理员审核"
- HTTP状态码：201

**示例：**
```
注册信息：
- 用户名：zhangsan
- 邮箱：zhangsan@example.com
- 手机：13800138000
- 密码：password123
→ 成功！状态：pending，等待管理员审核
```

### 场景2：信息已被使用

当用户尝试使用已存在的用户名、邮箱或手机号时：

- 系统检测到信息冲突
- 返回错误："用户名、邮箱或手机号已被使用"
- HTTP状态码：400

**示例：**
```
已存在的用户：
- 用户名：zhangsan
- 邮箱：zhangsan@example.com
- 手机：13800138000

新用户尝试注册：
- 用户名：lisi
- 邮箱：zhangsan@example.com  ← 冲突
- 手机：13900139000
→ 错误："用户名、邮箱或手机号已被使用"
```

### 场景3：被拒绝用户重新申请

当用户的注册申请被管理员拒绝后：

1. **用户记录被删除**：管理员拒绝申请时，系统会自动删除该用户的记录
2. **用户可以重新注册**：由于记录已删除，用户可以使用任何信息（包括原来的或修改后的）重新注册
3. **灵活性**：用户可以修正错误信息（如邮箱、手机号等）后重新提交

**示例流程：**
```
第一次注册：
- 用户名：zhangsan
- 邮箱：zhangsan@example.com（错误的邮箱）
- 手机：13800138000
→ 状态：pending

管理员拒绝：
→ 用户记录被删除

用户重新注册（可以修改任何信息）：
- 用户名：zhangsan（可以用原来的）
- 邮箱：zhangsan_correct@example.com（修正后的邮箱）
- 手机：13800138000（可以用原来的）
→ 成功！重新创建记录，状态：pending
```

## 冲突检测逻辑

系统检查以下字段的唯一性：

1. **用户名** - 必须唯一
2. **邮箱** - 必须唯一
3. **手机号** - 如果提供，必须唯一

检查范围：仅检查当前存在的用户（pending 和 active 状态），不包括已删除的用户。

## 操作日志

系统记录以下注册和审核相关的操作：

1. **user_register** - 新用户注册
   - operator_id: 新注册用户的ID
   - operation_detail: { username, email }

2. **user_approve** - 管理员批准用户
   - operator_id: 管理员ID
   - target_id: 被批准的用户ID
   - operation_detail: { action: 'approved' }

3. **user_reject** - 管理员拒绝用户并删除记录
   - operator_id: 管理员ID
   - target_id: 被拒绝的用户ID
   - operation_detail: { action: 'rejected_and_deleted', username, email }

## API接口

### POST /auth/register

注册新用户账户。

**请求体：**
```json
{
  "username": "zhangsan",
  "password": "password123",
  "email": "zhangsan@example.com",
  "phone": "13800138000"  // 可选
}
```

**成功响应：**
```json
{
  "message": "注册成功，请等待管理员审核",
  "userId": 123
}
```
HTTP状态码：201

**错误响应（信息冲突）：**
```json
{
  "error": "用户名、邮箱或手机号已被使用"
}
```
HTTP状态码：400

### PUT /users/:userId/approve

管理员审核用户注册申请（需要管理员权限）。

**请求体：**
```json
{
  "approve": true   // true: 批准, false: 拒绝
}
```

**批准成功响应：**
```json
{
  "message": "用户已批准",
  "userId": 123,
  "status": "active"
}
```
HTTP状态码：200

**拒绝成功响应：**
```json
{
  "message": "用户申请已拒绝，记录已删除",
  "userId": 123,
  "deleted": true
}
```
HTTP状态码：200

**说明：**
- **批准（approve: true）**：将用户状态从 `pending` 改为 `active`，用户可以登录
- **拒绝（approve: false）**：删除用户记录，用户可以使用任何信息重新注册

## 测试流程

### 测试完整的注册-拒绝-重新申请流程

**步骤1：用户首次注册**
```bash
POST /auth/register
{
  "username": "testuser",
  "password": "test123",
  "email": "test@example.com",
  "phone": "13800138000"
}
```
预期结果：成功，返回 userId，状态为 pending

**步骤2：管理员拒绝申请**
```bash
PUT /users/{userId}/approve
{
  "approve": false
}
```
预期结果：成功，用户记录被删除，返回 `{ "deleted": true }`

**步骤3：用户重新注册（使用相同信息）**
```bash
POST /auth/register
{
  "username": "testuser",
  "password": "newpass456",
  "email": "test@example.com",
  "phone": "13800138000"
}
```
预期结果：成功！因为之前的记录已被删除，可以使用相同的用户名、邮箱和手机号

**步骤4：用户重新注册（修改信息）**
```bash
POST /auth/register
{
  "username": "testuser",
  "password": "newpass456",
  "email": "test_new@example.com",  // 修改了邮箱
  "phone": "13900139000"            // 修改了手机号
}
```
预期结果：成功！用户可以自由修改任何信息

## 设计考虑

### 为什么拒绝时删除记录而不是保留？

**优点：**
1. **最大灵活性**：用户可以修正任何错误信息后重新申请，不受限制
2. **简化逻辑**：不需要复杂的状态管理和重新申请逻辑
3. **隐私保护**：被拒绝用户的信息不会长期保留在系统中
4. **避免资源占用**：数据库中只保留有效用户，不保留废弃记录

**如何保留审核历史：**
- 操作日志（operation_logs 表）中记录了拒绝操作，包含用户名和邮箱
- 管理员可以通过操作日志查看历史拒绝记录
- 日志保留了完整的审核轨迹，满足审计需求

### 潜在问题及解决方案

**问题1：恶意用户频繁申请**
- 当前方案：无限制
- 未来改进：可以基于IP地址或邮箱添加申请频率限制

**问题2：误删活跃用户**
- 解决方案：审核接口只处理 pending 状态的用户，可以添加额外检查

**问题3：无法追踪同一用户的多次申请**
- 解决方案：操作日志中保留了邮箱信息，可以通过日志查询

## 未来改进方向

1. **添加状态检查**：审核接口只允许操作 pending 状态的用户
2. **申请频率限制**：防止恶意用户频繁注册和重新申请
3. **软删除机制**：可选的软删除（添加 deleted_at 字段），保留完整历史
4. **黑名单功能**：允许管理员永久禁止某些邮箱或IP地址注册
5. **审核原因**：管理员拒绝时可以填写原因，记录到日志中
